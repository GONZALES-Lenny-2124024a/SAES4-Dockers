RUN apt-get update
RUN apt-get -y install postgresql-15-cron
RUN echo "shared_preload_libraries = 'pg_cron'" >> /var/lib/postgresql/data/postgresql.conf
RUN echo "cron.database_name = 'users'" >> /var/lib/postgresql/data/postgresql.conf
RUN echo "cron.timezone = 'UTC+1'" >> /var/lib/postgresql/data/postgresql.conf


RUN apt-get update
RUN apt-get -y install postgresql-15-cron
RUN su postgres && echo "shared_preload_libraries = 'pg_cron'" >> /var/lib/postgresql/data/postgresql.conf &&echo "cron.database_name = 'users'" >> /var/lib/postgresql/data/postgresql.conf && echo "cron.timezone = 'UTC+1'" >> /var/lib/postgresql/data/postgresql.conf


CREATE EXTENSION pg_cron;

CREATE OR REPLACE FUNCTION DELETE_TOKENS_EXPIRED() RETURNS void AS $$
BEGIN
  DELETE FROM RETRIEVE_PASSWORDS WHERE expiration_date < now() + interval '10 minutes';
END;
$$ LANGUAGE plpgsql;

SELECT cron.schedule('* * * * *', 'SELECT DELETE_TOKENS_EXPIRED()');